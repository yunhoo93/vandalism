<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µê³µê¸°ë¬¼ íŒŒì† ì‹ ê³  ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th,
        .reports-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .reports-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            color: #666;
        }

        .reports-table td {
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-received { background: #d4edda; color: #155724; }
        .status-reviewing { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #e2e3e5; color: #383d41; }

        .urgency-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .urgency-1 { background: #e9ecef; color: #6c757d; }
        .urgency-2 { background: #d4edda; color: #155724; }
        .urgency-3 { background: #fff3cd; color: #856404; }
        .urgency-4 { background: #f8d7da; color: #721c24; }
        .urgency-5 { background: #d1ecf1; color: #0c5460; }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }

        .cluster-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .cluster-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .cluster-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .emergency-alert {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ ê³µê³µê¸°ë¬¼ íŒŒì† ì‹ ê³  ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ì‹¤ì‹œê°„ ì‹ ê³  í˜„í™© ë° ì²˜ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
    </div>

    <div class="container">
        <button class="refresh-btn" onclick="refreshDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3 id="totalReports">-</h3>
                <p>ì „ì²´ ì‹ ê³ </p>
            </div>
            <div class="stat-card">
                <h3 id="recentReports">-</h3>
                <p>ìµœê·¼ 24ì‹œê°„</p>
            </div>
            <div class="stat-card">
                <h3 id="emergencyReports">-</h3>
                <p>ê¸´ê¸‰ ì‹ ê³ </p>
            </div>
            <div class="stat-card">
                <h3 id="clusterReports">-</h3>
                <p>êµ°ì§‘ ì‹ ê³ </p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">ğŸ“‹ ìµœê·¼ ì‹ ê³  í˜„í™©</div>
                <div class="card-body">
                    <div id="reportsTable">
                        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">ğŸ“Š ì‹ ê³  í†µê³„</div>
                <div class="card-body">
                    <div id="statisticsChart">
                        <div class="loading">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="card-header">ğŸ” êµ°ì§‘ ì‹ ê³  í˜„í™©</div>
            <div class="card-body">
                <div id="clusterInfo">
                    <div class="loading">êµ°ì§‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.refreshInterval = null;
                this.init();
            }

            init() {
                this.loadDashboard();
                // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
                this.refreshInterval = setInterval(() => {
                    this.loadDashboard();
                }, 30000);
            }

            async loadDashboard() {
                try {
                    await Promise.all([
                        this.loadStatistics(),
                        this.loadRecentReports(),
                        this.loadClusterInfo()
                    ]);
                } catch (error) {
                    console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            async loadStatistics() {
                try {
                    const response = await fetch('/api/statistics');
                    const stats = await response.json();
                    
                    document.getElementById('totalReports').textContent = stats.total_reports;
                    document.getElementById('recentReports').textContent = stats.recent_24h;
                    
                    // ê¸´ê¸‰ ì‹ ê³  ìˆ˜ ê³„ì‚° (ê¸´ê¸‰ë„ 4, 5)
                    const emergencyCount = (stats.urgency_distribution[4] || 0) + (stats.urgency_distribution[5] || 0);
                    document.getElementById('emergencyReports').textContent = emergencyCount;
                    
                    // í†µê³„ ì°¨íŠ¸ ìƒì„±
                    this.createStatisticsChart(stats);
                } catch (error) {
                    console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            async loadRecentReports() {
                try {
                    const response = await fetch('/api/reports');
                    const reports = await response.json();
                    
                    this.createReportsTable(reports);
                } catch (error) {
                    console.error('ì‹ ê³  ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            async loadClusterInfo() {
                try {
                    const response = await fetch('/api/clusters');
                    const clusterData = await response.json();
                    
                    document.getElementById('clusterReports').textContent = clusterData.cluster_count || 0;
                    this.createClusterInfo(clusterData.clusters);
                } catch (error) {
                    console.error('êµ°ì§‘ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            createStatisticsChart(stats) {
                const chartContainer = document.getElementById('statisticsChart');
                
                let chartHtml = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
                
                // ê¸´ê¸‰ë„ë³„ ë¶„í¬
                chartHtml += '<div>';
                chartHtml += '<h4 style="margin-bottom: 15px; color: #667eea;">ê¸´ê¸‰ë„ë³„ ë¶„í¬</h4>';
                const urgencyLabels = ['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš°ë†’ìŒ', 'ê¸´ê¸‰'];
                for (let i = 1; i <= 5; i++) {
                    const count = stats.urgency_distribution[i] || 0;
                    const percentage = stats.total_reports > 0 ? (count / stats.total_reports * 100).toFixed(1) : 0;
                    chartHtml += `<div style="margin: 8px 0; display: flex; justify-content: space-between;">`;
                    chartHtml += `<span>${urgencyLabels[i-1]}</span>`;
                    chartHtml += `<span><span class="urgency-badge urgency-${i}">${count}</span> (${percentage}%)</span>`;
                    chartHtml += `</div>`;
                }
                chartHtml += '</div>';
                
                // ì†ìƒ ìœ í˜•ë³„ ë¶„í¬
                chartHtml += '<div>';
                chartHtml += '<h4 style="margin-bottom: 15px; color: #667eea;">ì†ìƒ ìœ í˜•ë³„ ë¶„í¬</h4>';
                for (const [damageType, count] of Object.entries(stats.damage_type_distribution)) {
                    const percentage = stats.total_reports > 0 ? (count / stats.total_reports * 100).toFixed(1) : 0;
                    chartHtml += `<div style="margin: 8px 0; display: flex; justify-content: space-between;">`;
                    chartHtml += `<span>${damageType}</span>`;
                    chartHtml += `<span>${count} (${percentage}%)</span>`;
                    chartHtml += `</div>`;
                }
                chartHtml += '</div>';
                
                chartHtml += '</div>';
                chartContainer.innerHTML = chartHtml;
            }

            createReportsTable(reports) {
                const tableContainer = document.getElementById('reportsTable');
                
                if (!reports || reports.length === 0) {
                    tableContainer.innerHTML = '<div class="loading">ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                let tableHtml = '<table class="reports-table">';
                tableHtml += '<thead><tr>';
                tableHtml += '<th>ì‹ ê³ ë²ˆí˜¸</th><th>ì†ìƒìœ í˜•</th><th>ê¸´ê¸‰ë„</th><th>ìƒíƒœ</th><th>ì‹ ê³ ì‹œê°„</th>';
                tableHtml += '</tr></thead><tbody>';
                
                reports.slice(0, 10).forEach(report => {
                    const urgencyText = ['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš°ë†’ìŒ', 'ê¸´ê¸‰'][report.urgency_level - 1];
                    const statusText = {
                        'ì ‘ìˆ˜': 'ì ‘ìˆ˜ì™„ë£Œ',
                        'ê²€í† ì¤‘': 'ê²€í† ì¤‘',
                        'ì²˜ë¦¬ì¤‘': 'ì²˜ë¦¬ì¤‘',
                        'ì™„ë£Œ': 'ì²˜ë¦¬ì™„ë£Œ'
                    }[report.status] || report.status;
                    
                    tableHtml += '<tr>';
                    tableHtml += `<td>#${report.id}</td>`;
                    tableHtml += `<td>${report.damage_type}</td>`;
                    tableHtml += `<td><span class="urgency-badge urgency-${report.urgency_level}">${urgencyText}</span></td>`;
                    tableHtml += `<td><span class="status-badge status-${report.status.toLowerCase()}">${statusText}</span></td>`;
                    tableHtml += `<td>${new Date(report.created_at).toLocaleString()}</td>`;
                    tableHtml += '</tr>';
                });
                
                tableHtml += '</tbody></table>';
                tableContainer.innerHTML = tableHtml;
            }

            createClusterInfo(clusters) {
                const clusterContainer = document.getElementById('clusterInfo');
                
                if (!clusters || clusters.length === 0) {
                    clusterContainer.innerHTML = '<div class="loading">êµ°ì§‘ ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                let clusterHtml = '';
                clusters.forEach(cluster => {
                    clusterHtml += '<div class="cluster-info">';
                    clusterHtml += `<h4>êµ°ì§‘ ${cluster.cluster_id} (${cluster.report_count}ê±´)</h4>`;
                    clusterHtml += `<p><strong>ìœ„ì¹˜:</strong> ìœ„ë„ ${cluster.center_latitude.toFixed(6)}, ê²½ë„ ${cluster.center_longitude.toFixed(6)}</p>`;
                    clusterHtml += `<p><strong>ìµœê³  ê¸´ê¸‰ë„:</strong> <span class="urgency-badge urgency-${cluster.max_urgency}">${['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš°ë†’ìŒ', 'ê¸´ê¸‰'][cluster.max_urgency - 1]}</span></p>`;
                    
                    if (cluster.max_urgency >= 4) {
                        clusterHtml += '<div class="emergency-alert">âš ï¸ ê¸´ê¸‰ ì²˜ë¦¬ê°€ í•„ìš”í•œ êµ°ì§‘ì…ë‹ˆë‹¤!</div>';
                    }
                    
                    clusterHtml += '</div>';
                });
                
                clusterContainer.innerHTML = clusterHtml;
            }
        }

        function refreshDashboard() {
            if (window.dashboard) {
                window.dashboard.loadDashboard();
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
        window.dashboard = new Dashboard();
    </script>
</body>
</html>
